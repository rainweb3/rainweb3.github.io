# Solidity è‡ªå®šä¹‰é”™è¯¯ï¼ˆCustom Errorsï¼‰è¯¦è§£ï¼ˆ2025ï¼‰

> **é€‚ç”¨ç‰ˆæœ¬ï¼šSolidity 0.8.4+**  
> è‡ªå®šä¹‰é”™è¯¯æ˜¯ Solidity 0.8.4 å¼•å…¥çš„é‡Œç¨‹ç¢‘ç‰¹æ€§ï¼Œå½»åº•è§£å†³äº†ä¼ ç»Ÿ `require` è¯­å¥åœ¨ **Gas æˆæœ¬ã€è°ƒè¯•æ•ˆç‡ã€ä»£ç å¯ç»´æŠ¤æ€§** ä¸Šçš„ç—›ç‚¹ï¼Œå·²æˆä¸ºç°ä»£ç”Ÿäº§çº§åˆçº¦å¼€å‘çš„æ ‡å‡†å®è·µã€‚

---

## ğŸ“š ç›®å½•

1. [å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰é”™è¯¯ï¼Ÿ](#ä¸€å¼•è¨€ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰é”™è¯¯)
2. [åŸºæœ¬è¯­æ³•ï¼šå®šä¹‰ä¸è§¦å‘](#äºŒåŸºæœ¬è¯­æ³•å®šä¹‰ä¸è§¦å‘)
    - 2.1 å®šä¹‰è‡ªå®šä¹‰é”™è¯¯
    - 2.2 è§¦å‘è‡ªå®šä¹‰é”™è¯¯
3. [å®Œæ•´ç¤ºä¾‹ï¼šå®æˆ˜åˆçº¦](#ä¸‰å®Œæ•´ç¤ºä¾‹å®æˆ˜åˆçº¦)
4. [æ ¸å¿ƒå¯¹æ¯”ï¼šè‡ªå®šä¹‰é”™è¯¯ vs ä¼ ç»Ÿ `require`](#å››æ ¸å¿ƒå¯¹æ¯”è‡ªå®šä¹‰é”™è¯¯-vs-ä¼ ç»Ÿ-require)
    - 4.1 å¯¹æ¯”ç»´åº¦ä¸€è§ˆ
    - 4.2 Gas æ¶ˆè€—å®æµ‹åˆ†æ
5. [è®¾è®¡ä»·å€¼ä¸å®è·µåº”ç”¨](#äº”è®¾è®¡ä»·å€¼ä¸å®è·µåº”ç”¨)
    - 5.1 Gas ä¼˜åŒ–æœºåˆ¶
    - 5.2 è°ƒè¯•èƒ½åŠ›æå‡
    - 5.3 ä»£ç å¯ç»´æŠ¤æ€§å¢å¼º
    - 5.4 æ¨èä½¿ç”¨åœºæ™¯
    - 5.5 æç®€åœºæ™¯ä¿ç•™ `require`
    - 5.6 è·¨åˆçº¦é”™è¯¯å¤ç”¨
6. [å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰](#å…­å…³é”®æ³¨æ„äº‹é¡¹é¿å‘æŒ‡å—)
7. [è¿›é˜¶æŠ€å·§ï¼šé”™è¯¯ä¸äº‹ä»¶ååŒè°ƒè¯•](#ä¸ƒè¿›é˜¶æŠ€å·§é”™è¯¯ä¸äº‹ä»¶ååŒè°ƒè¯•)
8. [å·¥å…·é“¾æ”¯æŒç°çŠ¶è¯´æ˜](#å…«å·¥å…·é“¾æ”¯æŒç°çŠ¶è¯´æ˜)
9. [æ€»ç»“ï¼šè‡ªå®šä¹‰é”™è¯¯çš„æ ¸å¿ƒä»·å€¼](#ä¹æ€»ç»“è‡ªå®šä¹‰é”™è¯¯çš„æ ¸å¿ƒä»·å€¼)

---

## ä¸€ã€å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰é”™è¯¯ï¼Ÿ

åœ¨ Solidity 0.8.4 ä¹‹å‰ï¼Œå¼€å‘è€…ä¸»è¦ä¾èµ– `require(condition, "error message")` æ¥å¤„ç†è¿è¡Œæ—¶æ ¡éªŒå¤±è´¥ã€‚è™½ç„¶ç®€å•ç›´è§‚ï¼Œä½†å­˜åœ¨ä»¥ä¸‹ä¸¥é‡é—®é¢˜ï¼š

- **é«˜æ˜‚çš„ Gas å¼€é”€**ï¼šé”™è¯¯æ¶ˆæ¯å­—ç¬¦ä¸²åœ¨ç¼–è¯‘æ—¶è¢«ç¼–ç è¿›åˆçº¦å­—èŠ‚ç ï¼Œå³ä½¿ä»æœªè§¦å‘ä¹Ÿä¼šæ°¸ä¹…å ç”¨åˆçº¦ä½“ç§¯ã€‚
- **æ— æ³•ä¼ é€’ä¸Šä¸‹æ–‡å‚æ•°**ï¼šæç¤ºä¿¡æ¯å›ºå®šï¼Œæ— æ³•åŠ¨æ€å±•ç¤ºâ€œå®é™…å€¼ vs æœŸæœ›å€¼â€ç­‰å…³é”®ä¿¡æ¯ã€‚
- **éš¾ä»¥è°ƒè¯•å’Œç»´æŠ¤**ï¼šå½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œå‰ç«¯åªèƒ½çœ‹åˆ°é™æ€æ–‡æœ¬ï¼Œç¼ºä¹å®šä½é—®é¢˜æ‰€éœ€çš„ä¸Šä¸‹æ–‡ã€‚
- **åˆ†æ•£å¼ç®¡ç†**ï¼šé”™è¯¯æç¤ºæ•£è½åœ¨å„å‡½æ•°ä¸­ï¼Œä¸åˆ©äºç»Ÿä¸€è§„èŒƒå’Œé‡æ„ã€‚

ä¸ºè§£å†³è¿™äº›é—®é¢˜ï¼ŒSolidity å›¢é˜Ÿåœ¨ **0.8.4 ç‰ˆæœ¬**æ­£å¼å¼•å…¥äº† **è‡ªå®šä¹‰é”™è¯¯ï¼ˆCustom Errorsï¼‰**ã€‚å®ƒé€šè¿‡ç±»ä¼¼äº‹ä»¶çš„æœºåˆ¶ï¼Œå°†é”™è¯¯ç±»å‹ç¼–ç ä¸º 4 å­—èŠ‚é€‰æ‹©å™¨ï¼Œå¹¶å…è®¸æºå¸¦å‚æ•°ï¼Œå®ç°äº†é«˜æ•ˆã€çµæ´»ã€å¯æ‰©å±•çš„é”™è¯¯å¤„ç†æ¨¡å¼ã€‚

> âœ… **å½“å‰æ ‡å‡†**ï¼šè‡ªå®šä¹‰é”™è¯¯å·²æˆä¸ºç°ä»£ Solidity å¼€å‘çš„äº‹å®æ ‡å‡†ï¼Œå°¤å…¶é€‚ç”¨äº DeFiã€NFTã€DAO ç­‰å¤æ‚ä¸”å¯¹æˆæœ¬æ•æ„Ÿçš„é¡¹ç›®ã€‚

---

## äºŒã€åŸºæœ¬è¯­æ³•ï¼šå®šä¹‰ä¸è§¦å‘

### 2.1 å®šä¹‰è‡ªå®šä¹‰é”™è¯¯

è‡ªå®šä¹‰é”™è¯¯å¿…é¡»åœ¨ **åˆçº¦æˆ–æ¥å£çš„å…¨å±€ä½œç”¨åŸŸ** ä¸­å®šä¹‰ï¼Œä¸èƒ½åœ¨å‡½æ•°å†…éƒ¨å£°æ˜ã€‚

#### è¯­æ³•æ ¼å¼ï¼š
```solidity
error ErrorName(Type param1, Type param2, ...);
```

#### ç¤ºä¾‹ï¼š
```solidity
// å¸¦å‚æ•°çš„é”™è¯¯
error NotOwner(address caller, address expectedOwner);

// æ— å‚æ•°çš„é”™è¯¯
error InsufficientBalance();

// å¤šå‚æ•°é”™è¯¯
error InvalidInput(uint256 input, uint256 minAllowed);
```

#### å‘½åå»ºè®®ï¼š
- ä½¿ç”¨ `PascalCase` é£æ ¼ï¼ˆå¦‚ `AccessDenied`ï¼‰ï¼Œé¿å…ä¸‹åˆ’çº¿æˆ–å°é©¼å³°ã€‚
- åç§°åº”æ¸…æ™°è¡¨è¾¾é”™è¯¯è¯­ä¹‰ï¼Œä¾¿äºå›¢é˜Ÿåä½œç†è§£ã€‚

#### å‚æ•°ç±»å‹é™åˆ¶ï¼š
- âœ… æ”¯æŒæ‰€æœ‰ **å€¼ç±»å‹** å’Œ **å›ºå®šé•¿åº¦å¼•ç”¨ç±»å‹**ï¼š
    - å€¼ç±»å‹ï¼š`bool`, `uint`, `int`, `address`
    - å›ºå®šé•¿åº¦å­—èŠ‚ï¼š`bytes1` åˆ° `bytes32`
    - å›ºå®šé•¿åº¦æ•°ç»„ï¼š`uint256[3]`
- âŒ ä¸æ”¯æŒåŠ¨æ€å¼•ç”¨ç±»å‹ï¼š
    - `string`
    - åŠ¨æ€æ•°ç»„ï¼š`uint256[]`
    - å¤æ‚ `struct`ï¼ˆå«åŠ¨æ€å­—æ®µï¼‰

> ğŸ”§ **æç¤º**ï¼šè‹¥éœ€ä¼ é€’çŸ­å­—ç¬¦ä¸²ï¼Œå¯ç”¨ `bytes32` ç¼–ç ï¼›é•¿æ–‡æœ¬å»ºè®®é€šè¿‡ `Event` è®°å½•ã€‚

---

### 2.2 è§¦å‘è‡ªå®šä¹‰é”™è¯¯

å¿…é¡»ä½¿ç”¨ `revert` å…³é”®å­—è§¦å‘ï¼Œ**ä¸èƒ½ä½¿ç”¨ `require` æˆ– `assert`**ã€‚

#### è¯­æ³•æ ¼å¼ï¼š
```solidity
if (!condition) revert ErrorName(arg1, arg2, ...);
```

#### ç¤ºä¾‹ï¼š
```solidity
function withdraw() external {
    // æ¡ä»¶åˆ¤æ–­ + revert è§¦å‘
    if (msg.sender != owner) {
        revert NotOwner(msg.sender, owner);
    }

    if (address(this).balance == 0) {
        revert InsufficientBalance();
    }
}
```

#### æ³¨æ„äº‹é¡¹ï¼š
- å¿…é¡»æ˜¾å¼å†™ `revert`ï¼Œä¸å¯çœç•¥ã€‚
- å‚æ•°æ•°é‡å’Œç±»å‹å¿…é¡»ä¸å®šä¹‰ä¸€è‡´ï¼Œå¦åˆ™ç¼–è¯‘æŠ¥é”™ã€‚
- é”™è¯¯ä¸€æ—¦è§¦å‘ï¼Œäº¤æ˜“ç«‹å³å›æ»šå¹¶è¿”å›é”™è¯¯æ•°æ®ã€‚

---

## ä¸‰ã€å®Œæ•´ç¤ºä¾‹ï¼šå®æˆ˜åˆçº¦

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¸¦è‡ªå®šä¹‰é”™è¯¯çš„é’±åŒ…åˆçº¦ï¼Œæ¶µç›–æƒé™æ§åˆ¶ã€å­˜æ¬¾æ ¡éªŒã€è½¬è´¦å¤±è´¥å¤„ç†ç­‰å¸¸è§åœºæ™¯ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20; // æ¨èä½¿ç”¨ 0.8.20+ ä»¥åŒ…å«å®‰å…¨ä¿®å¤

contract WalletWithCustomErrors {
    address public immutable owner;
    uint256 public minimumDeposit;

    // ğŸ”¹ é›†ä¸­å®šä¹‰æ‰€æœ‰é”™è¯¯ï¼ˆä¾¿äºç»´æŠ¤ï¼‰
    error NotOwner(address caller, address owner);
    error InsufficientDeposit(uint256 sent, uint256 required);
    error TransferFailed(address recipient, uint256 amount);
    error WithdrawDisabled();

    constructor(uint256 _minimumDeposit) {
        owner = msg.sender;
        minimumDeposit = _minimumDeposit;
    }

    // å­˜æ¬¾ï¼šé‡‘é¢ä¸è¶³æ—¶è§¦å‘é”™è¯¯
    function deposit() external payable {
        if (msg.value < minimumDeposit) {
            revert InsufficientDeposit(msg.value, minimumDeposit);
        }
    }

    // ææ¬¾ï¼šåŒ…å«æƒé™ã€æ—¶é—´é”ã€è½¬è´¦å¤±è´¥æ£€æŸ¥
    function withdraw(address recipient) external {
        // æƒé™æ ¡éªŒ
        if (msg.sender != owner) {
            revert NotOwner(msg.sender, owner);
        }

        // æ—¶é—´é”ï¼ˆç¤ºä¾‹ï¼‰
        if (block.timestamp < 1719744000) { // 2024-07-01 00:00:00 UTC
            revert WithdrawDisabled();
        }

        uint256 balance = address(this).balance;
        (bool success, ) = recipient.call{value: balance}("");
        if (!success) {
            revert TransferFailed(recipient, balance);
        }
    }
}
```

### é”™è¯¯è¿”å›ç»“æœï¼ˆå‰ç«¯å¯è¯»ï¼‰

å½“è°ƒç”¨å¤±è´¥æ—¶ï¼ŒèŠ‚ç‚¹è¿”å›ç»“æ„åŒ–é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚é€šè¿‡ Ethers.jsï¼‰ï¼š

```json
{
  "error": "InsufficientDeposit",
  "args": {
    "sent": "500000000000000000",
    "required": "1000000000000000000"
  }
}
```

å‰ç«¯å¯æ®æ­¤æç¤ºç”¨æˆ·ï¼šâ€œæ‚¨å‘é€äº† 0.5 ETHï¼Œä½†æœ€ä½å­˜æ¬¾è¦æ±‚ä¸º 1 ETHâ€ã€‚

---

## å››ã€æ ¸å¿ƒå¯¹æ¯”ï¼šè‡ªå®šä¹‰é”™è¯¯ vs ä¼ ç»Ÿ `require`

| å¯¹æ¯”ç»´åº¦         | ä¼ ç»Ÿ `require` è¯­å¥                          | è‡ªå®šä¹‰é”™è¯¯ï¼ˆCustom Errorsï¼‰                   |
|------------------|---------------------------------------------|-----------------------------------------------|
| **è¯­æ³•é€»è¾‘**     | æ¡ä»¶åˆ¤æ–­ä¸æç¤ºè€¦åˆï¼š`require(cond, "msg")`  | é€»è¾‘ä¸é”™è¯¯åˆ†ç¦»ï¼š`if (!cond) revert Err(params)` |
| **Gas æ¶ˆè€—**     | é«˜ï¼ˆå­—ç¬¦ä¸²ç¼–è¯‘è¿›å­—èŠ‚ç ï¼‰                    | æä½ï¼ˆä»…4å­—èŠ‚é€‰æ‹©å™¨+åŠ¨æ€å‚æ•°ï¼‰                |
| **éƒ¨ç½²æˆæœ¬**     | é«˜ï¼ˆé•¿å­—ç¬¦ä¸²å¢åŠ åˆçº¦ä½“ç§¯ï¼‰                  | ä½ï¼ˆé”™è¯¯å®šä¹‰ä¸å ç”¨é¢å¤–å­˜å‚¨ï¼‰                  |
| **å‚æ•°ä¼ é€’**     | âŒ ä¸æ”¯æŒï¼ˆæç¤ºå›ºå®šï¼‰                       | âœ… æ”¯æŒåŠ¨æ€å‚æ•°ï¼ˆåœ°å€ã€æ•°å€¼ç­‰ä¸Šä¸‹æ–‡ï¼‰          |
| **è°ƒè¯•æ•ˆç‡**     | æ¨¡ç³Šæ–‡æœ¬ï¼ˆå¦‚â€œæƒé™ä¸è¶³â€ï¼‰                    | ç²¾å‡†ä¿¡æ¯ï¼ˆå¦‚â€œè°ƒç”¨è€…0x...ä¸æ˜¯æ‰€æœ‰è€…0x...â€ï¼‰    |
| **å¯ç»´æŠ¤æ€§**     | é”™è¯¯æç¤ºåˆ†æ•£åœ¨å‡½æ•°ä¸­                        | é›†ä¸­å®šä¹‰ï¼Œä¾¿äºå›¢é˜Ÿåä½œå’Œè¿­ä»£                  |
| **é€‚ç”¨åœºæ™¯**     | æç®€åŸå‹ã€ä¸´æ—¶éªŒè¯                          | ç”Ÿäº§çº§åˆçº¦ã€DeFiã€NFTç­‰å¤æ‚ç³»ç»Ÿ               |

---

### 4.2 Gas æ¶ˆè€—å®æµ‹åˆ†æï¼ˆä»¥æƒé™æ ¡éªŒä¸ºä¾‹ï¼‰

| å®ç°æ–¹å¼ | éƒ¨ç½² Gas | è°ƒç”¨å¤±è´¥ Gas |
|--------|---------|-------------|
| `require(msg.sender == owner, "Not owner")` | ~98,000 | ~23,000 |
| `if (msg.sender != owner) revert NotOwner(msg.sender, owner)` | ~95,500 | ~21,500 |

> ğŸ” **æ³¨**ï¼šGas æ•°æ®åŸºäº Solidity 0.8.20 + Hardhat æœ¬åœ°èŠ‚ç‚¹ä¼°ç®—ï¼Œå®é™…å€¼å› ç¼–è¯‘å™¨ä¼˜åŒ–ã€ç½‘ç»œçŠ¶æ€ç•¥æœ‰æµ®åŠ¨ï¼Œä½†è¶‹åŠ¿ä¸€è‡´ã€‚
>
> **èŠ‚çœæ•ˆæœ**ï¼š
> - éƒ¨ç½² Gas èŠ‚çœçº¦ **2.5%**
> - å¤±è´¥è°ƒç”¨ Gas èŠ‚çœçº¦ **6.5%**
>
> åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼ˆå¦‚ Aaveã€Uniswapï¼‰ï¼Œè¿™ç§ä¼˜åŒ–ç´¯ç§¯æ˜¾è‘—ï¼Œå°¤å…¶åœ¨é«˜é¢‘äº¤äº’åœºæ™¯ä¸‹ã€‚

---

## äº”ã€è®¾è®¡ä»·å€¼ä¸å®è·µåº”ç”¨

### 5.1 Gas ä¼˜åŒ–ï¼šä»â€œå­˜å‚¨å­—ç¬¦ä¸²â€åˆ°â€œé”™è¯¯é€‰æ‹©å™¨â€

- **ä¼ ç»Ÿæ–¹å¼**ï¼š`"Not owner"` å­—ç¬¦ä¸²è¢«ç¼–è¯‘è¿›å­—èŠ‚ç ï¼Œæ°¸ä¹…å ç”¨åˆçº¦ç©ºé—´ã€‚
- **è‡ªå®šä¹‰é”™è¯¯**ï¼šé”™è¯¯åå’Œå‚æ•°ç±»å‹ç”Ÿæˆä¸€ä¸ª **4å­—èŠ‚çš„é€‰æ‹©å™¨**ï¼ˆç±»ä¼¼å‡½æ•°é€‰æ‹©å™¨ï¼‰ï¼Œä»…åœ¨è§¦å‘æ—¶ç¼–ç å‚æ•°è¿”å›ã€‚

ä¾‹å¦‚ï¼š
```solidity
error NotOwner(address, address);
```
å…¶é€‰æ‹©å™¨ä¸ºï¼š
```js
// keccak256("NotOwner(address,address)")[0:4]
0x8a49f65c
```
è¯¥ 4 å­—èŠ‚æ ‡è¯†ç¬¦ + ABI ç¼–ç å‚æ•°æ„æˆè¿”å›æ•°æ®ï¼Œæå¤§èŠ‚çœé“¾ä¸Šèµ„æºã€‚

---

### 5.2 è°ƒè¯•èƒ½åŠ›æå‡ï¼šä»â€œæ¨¡ç³Šæç¤ºâ€åˆ°â€œä¸Šä¸‹æ–‡å®Œæ•´â€

ä¼ ç»Ÿé”™è¯¯ï¼š
```solidity
require(success, "Transfer failed");
```
â†’ å‰ç«¯åªçŸ¥é“â€œè½¬è´¦å¤±è´¥â€ï¼Œä¸çŸ¥é“æ˜¯è°ã€è½¬å¤šå°‘ã€ç›®æ ‡åœ°å€ã€‚

è‡ªå®šä¹‰é”™è¯¯ï¼š
```solidity
revert TransferFailed(recipient, amount);
```
â†’ å‰ç«¯å¯å±•ç¤ºï¼šâ€œå‘åœ°å€ `0x...` è½¬è´¦ `1.5 ETH` å¤±è´¥â€ï¼Œä¾¿äºå¿«é€Ÿæ’æŸ¥ã€‚

---

### 5.3 ä»£ç å¯ç»´æŠ¤æ€§å¢å¼ºï¼šé›†ä¸­åŒ–ç®¡ç†

å°†é”™è¯¯é›†ä¸­å®šä¹‰åœ¨åˆçº¦é¡¶éƒ¨æˆ–ç‹¬ç«‹æ¥å£ä¸­ï¼Œå¸¦æ¥ä»¥ä¸‹å¥½å¤„ï¼š
- ç»Ÿä¸€å‘½åè§„èŒƒï¼ˆå¦‚ `ErrorPrefix_`ï¼‰
- å¿«é€ŸæŸ¥æ‰¾æ‰€æœ‰é”™è¯¯ç±»å‹
- ä¿®æ”¹é”™è¯¯å‚æ•°æ—¶æ— éœ€éå†å¤šä¸ªå‡½æ•°
- æ”¯æŒæ–‡æ¡£ç”Ÿæˆå·¥å…·æå–é”™è¯¯åˆ—è¡¨

---

### 5.4 æ¨èä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯çš„åœºæ™¯

| åœºæ™¯ | åŸå›  | ç¤ºä¾‹ |
|------|------|------|
| **DeFi åˆçº¦** | é«˜é¢‘äº¤äº’ï¼ŒGas æ•æ„Ÿï¼Œéœ€ç²¾å‡†é£æ§ | `InsufficientCollateral(address user, uint256 required)` |
| **æƒé™ç®¡ç†** | éœ€æ˜ç¡®â€œè°æ— æƒé™â€ | `Unauthorized(address caller, bytes32 role)` |
| **å‚æ•°æ ¡éªŒ** | éœ€å¯¹æ¯”è¾“å…¥ä¸åˆæ³•èŒƒå›´ | `InvalidAmount(uint256 input, uint256 min, uint256 max)` |
| **è·¨åˆçº¦è°ƒç”¨** | éœ€ä¼ é€’å¤–éƒ¨è°ƒç”¨å¤±è´¥ä¸Šä¸‹æ–‡ | `ExternalCallFailed(address target, bytes data)` |

---

### 5.5 å¯ä¿ç•™ `require` çš„æç®€åœºæ™¯

ä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘ä½¿ç”¨ `require`ï¼š

```solidity
// âœ… åˆç†ï¼šæç®€ã€æ— å‚æ•°ã€é«˜é¢‘æ ¡éªŒ
function pause() external {
    require(msg.sender == owner, "Owner only");
    paused = true;
}
```

> ğŸ“Œ å»ºè®®ï¼šå³ä½¿åœ¨æ­¤ç±»åœºæ™¯ï¼Œä¹Ÿæ¨èä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ä»¥ä¿æŒä»£ç é£æ ¼ç»Ÿä¸€ã€‚

---

### 5.6 è¿›é˜¶æŠ€å·§ï¼šè·¨åˆçº¦å¤ç”¨é”™è¯¯

é€šè¿‡æ¥å£å®šä¹‰é€šç”¨é”™è¯¯ï¼Œå®ç°å¤šåˆçº¦å…±äº«è§„èŒƒã€‚

```solidity
// ICommonErrors.sol
interface ICommonErrors {
    error NotOwner(address caller);
    error InvalidInput();
    error ActionDisabled();
}

// MyContract.sol
contract MyContract is ICommonErrors {
    address public owner;

    constructor() {
        owner = msg.sender;
    }

    function doSomething() external {
        if (msg.sender != owner) {
            revert NotOwner(msg.sender); // ä½¿ç”¨æ¥å£å®šä¹‰çš„é”™è¯¯
        }
    }
}
```

> âœ… ä¼˜åŠ¿ï¼šå›¢é˜Ÿå¯å®šä¹‰æ ‡å‡†é”™è¯¯åº“ï¼Œæå‡ä»£ç ä¸€è‡´æ€§ã€‚

---

## å…­ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰

| é—®é¢˜ | è¯´æ˜ | æ­£ç¡®åšæ³• |
|------|------|----------|
| **1. å‡½æ•°å†…å®šä¹‰é”™è¯¯** | âŒ ç¼–è¯‘é”™è¯¯ | å¿…é¡»åœ¨åˆçº¦/æ¥å£é¡¶å±‚å®šä¹‰ |
| **2. ä½¿ç”¨ `require` è§¦å‘é”™è¯¯** | âŒ è¯­æ³•é”™è¯¯ | å¿…é¡»ç”¨ `revert ErrName(...)` |
| **3. ä½¿ç”¨ `string` ä½œä¸ºå‚æ•°** | âŒ ä¸æ”¯æŒå¼•ç”¨ç±»å‹ | ç”¨ `bytes32` æ›¿ä»£ |
| **4. ç‰ˆæœ¬ä½äº 0.8.4** | âŒ ä¸è¯†åˆ« `error` å…³é”®å­— | å‡çº§è‡³ `^0.8.4` æˆ–æ›´é«˜ |

### é”™è¯¯ç¤ºä¾‹æ±‡æ€»ï¼š

```solidity
// âŒ é”™è¯¯ 1ï¼šå‡½æ•°å†…å®šä¹‰
function bad() external {
    error InFuncError(); // ç¼–è¯‘å¤±è´¥
}

// âŒ é”™è¯¯ 2ï¼šç”¨ require è°ƒç”¨é”™è¯¯
require(msg.sender == owner, NotOwner(msg.sender)); // è¯­æ³•é”™è¯¯

// âŒ é”™è¯¯ 3ï¼šä½¿ç”¨ string å‚æ•°
error InvalidName(string name); // ä¸æ”¯æŒ

// âŒ é”™è¯¯ 4ï¼šç‰ˆæœ¬è¿‡ä½
pragma solidity ^0.8.3;
error MyError(); // æ— æ³•è¯†åˆ«
```

---

## ä¸ƒã€è¿›é˜¶æŠ€å·§ï¼šé”™è¯¯ä¸äº‹ä»¶ååŒè°ƒè¯•

ç»“åˆ `Event` å’Œ `Custom Error`ï¼Œå¯åœ¨äº¤æ˜“å¤±è´¥æ—¶ä»ä¿ç•™æ“ä½œæ—¥å¿—ï¼Œä¾¿äºé—®é¢˜å¤ç°ã€‚

```solidity
contract WalletWithEventsAndErrors {
    event DepositAttempt(address indexed user, uint256 amount);
    event WithdrawAttempt(address indexed user, address indexed recipient);

    error InsufficientDeposit(uint256 sent, uint256 required);
    error NotOwner(address caller, address owner);

    function deposit() external payable {
        emit DepositAttempt(msg.sender, msg.value); // æ—¥å¿—è®°å½•
        if (msg.value < 1 ether) {
            revert InsufficientDeposit(msg.value, 1 ether); // è§¦å‘é”™è¯¯
        }
    }

    function withdraw(address recipient) external {
        emit WithdrawAttempt(msg.sender, recipient);
        if (msg.sender != owner) {
            revert NotOwner(msg.sender, owner);
        }
        // ... è½¬è´¦é€»è¾‘
    }
}
```

> ğŸ” **ä¼˜åŠ¿**ï¼šå³ä½¿äº¤æ˜“å¤±è´¥ï¼Œ`DepositAttempt` äº‹ä»¶ä»ä¼šè¢«è®°å½•ï¼Œå¯é€šè¿‡ Etherscan æŸ¥çœ‹â€œç”¨æˆ·å°è¯•äº†ä»€ä¹ˆæ“ä½œâ€ï¼Œæå¤§æå‡è°ƒè¯•æ•ˆç‡ã€‚

#### å‰ç«¯è°ƒè¯•ç¤ºä¾‹ï¼ˆEthers.jsï¼‰ï¼š
```js
try {
    await contract.deposit({ value: ethers.parseEther("0.5") });
} catch (error) {
    console.log("äº¤æ˜“å¤±è´¥ï¼Œä½†å¯è¯»å–äº‹ä»¶æ—¥å¿—ï¼š");
    const receipt = await provider.getTransactionReceipt(error.transactionHash);
    const iface = new ethers.Interface(abi);
    const logs = receipt.logs.map(log => {
        try {
            return iface.parseLog(log);
        } catch {
            return null;
        }
    }).filter(Boolean);

    logs.forEach(log => {
        if (log.name === "DepositAttempt") {
            console.log(`ç”¨æˆ· ${log.args.user} å°è¯•å­˜æ¬¾ ${ethers.formatEther(log.args.amount)} ETH`);
        }
    });
}
```

---

## å…«ã€å·¥å…·é“¾æ”¯æŒç°çŠ¶è¯´æ˜

> **å…³äº Truffle æ˜¯å¦è¿‡æ—¶ï¼Ÿ**

**ç»“è®º**ï¼š**Truffle å¹¶æœªè¿‡æ—¶ï¼Œä½†å…¶ç”Ÿæ€æ´»è·ƒåº¦å·²æ˜¾è‘—ä½äº Hardhat å’Œ Foundryã€‚**

| å·¥å…· | å½“å‰çŠ¶æ€ | æ”¯æŒè‡ªå®šä¹‰é”™è¯¯ |
|------|----------|----------------|
| **Hardhat** | âœ… ä¸»æµé¦–é€‰ï¼Œæ’ä»¶ä¸°å¯Œï¼Œè°ƒè¯•å¼ºå¤§ | å®Œç¾æ”¯æŒ |
| **Foundry** | âœ… æ–°ä¸€ä»£å·¥å…·é“¾ï¼Œé€Ÿåº¦å¿«ï¼ŒRust ç¼–å†™ | å®Œç¾æ”¯æŒï¼ˆ`vm.expectRevert`ï¼‰ |
| **Remix** | âœ… åœ¨çº¿ IDEï¼Œé€‚åˆæ•™å­¦å’Œå¿«é€ŸéªŒè¯ | å®Œç¾æ”¯æŒï¼ˆæ§åˆ¶å°è¾“å‡ºé”™è¯¯å‚æ•°ï¼‰ |
| **Truffle** | âš ï¸ ä»åœ¨ç»´æŠ¤ï¼Œä½†æ›´æ–°ç¼“æ…¢ï¼Œç¤¾åŒºè½¬å‘ Hardhat | âœ… æ”¯æŒï¼Œä½†æ’ä»¶ç”Ÿæ€è¾ƒå¼± |

> ğŸ“Œ **å»ºè®®**ï¼š
> - æ–°é¡¹ç›®æ¨èä½¿ç”¨ **Hardhat** æˆ– **Foundry**ã€‚
> - Truffle å¯ç”¨äºé—ç•™é¡¹ç›®ç»´æŠ¤æˆ–å­¦ä¹ ç”¨é€”ï¼Œä½†ä¸å»ºè®®ä½œä¸ºæ–°é¡¹ç›®é¦–é€‰ã€‚

---

## ä¹ã€æ€»ç»“ï¼šè‡ªå®šä¹‰é”™è¯¯çš„æ ¸å¿ƒä»·å€¼

| ä»·å€¼ç»´åº¦         | å…·ä½“ä½“ç°                                  |
|------------------|-------------------------------------------|
| **æˆæœ¬ä¼˜åŒ–**     | é™ä½åˆçº¦éƒ¨ç½²å’Œè°ƒç”¨çš„ Gas æ¶ˆè€—ï¼Œå°¤å…¶é€‚åˆé«˜é¢‘äº¤äº’åœºæ™¯ |
| **è°ƒè¯•æ•ˆç‡**     | æä¾›ç²¾å‡†ä¸Šä¸‹æ–‡å‚æ•°ï¼Œå‡å°‘é—®é¢˜å®šä½æ—¶é—´        |
| **ä»£ç è´¨é‡**     | é”™è¯¯å®šä¹‰é›†ä¸­åŒ–ï¼Œæå‡å¯ç»´æŠ¤æ€§å’Œå›¢é˜Ÿåä½œæ•ˆç‡  |
| **ç”Ÿæ€é€‚é…**     | ä¸»æµå·¥å…·ï¼ˆRemixã€Hardhatã€Foundryï¼‰å‡å·²å®Œç¾æ”¯æŒ |

> ğŸ **æœ€ç»ˆå»ºè®®**ï¼š  
> åœ¨ **Solidity 0.8.4+** ç¯å¢ƒä¸‹ï¼Œ**è‡ªå®šä¹‰é”™è¯¯åº”ä½œä¸ºé¦–é€‰é”™è¯¯å¤„ç†æ–¹å¼**ï¼Œä»…åœ¨æç®€æ— å‚æ•°åœºæ™¯ä¸‹è€ƒè™‘ `require`ã€‚å¯¹äºç”Ÿäº§çº§åˆçº¦ï¼ˆå°¤å…¶æ˜¯ DeFiã€NFT ç­‰ç”¨æˆ·é‡é«˜çš„é¡¹ç›®ï¼‰ï¼Œè‡ªå®šä¹‰é”™è¯¯æ˜¯æå‡åˆçº¦è´¨é‡çš„â€œæ ‡é…â€ã€‚
