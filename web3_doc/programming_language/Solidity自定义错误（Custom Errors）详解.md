# Solidity è‡ªå®šä¹‰é”™è¯¯ï¼ˆCustom Errorsï¼‰è¯¦è§£

> **é€‚ç”¨ç‰ˆæœ¬ï¼šSolidity 0.8.4+**  
> è‡ªå®šä¹‰é”™è¯¯æ˜¯ Solidity 0.8.4 å¼•å…¥çš„é‡Œç¨‹ç¢‘ç‰¹æ€§ï¼Œå½»åº•è§£å†³äº†ä¼ ç»Ÿ `require` è¯­å¥åœ¨ **Gas æˆæœ¬ã€è°ƒè¯•æ•ˆç‡ã€ä»£ç å¯ç»´æŠ¤æ€§** ä¸Šçš„ç—›ç‚¹ï¼Œå·²æˆä¸ºç”Ÿäº§çº§åˆçº¦å¼€å‘çš„æ ‡å‡†å®è·µã€‚


## ä¸€ã€åŸºæœ¬è¯­æ³•ï¼šå®šä¹‰ä¸è§¦å‘
è‡ªå®šä¹‰é”™è¯¯çš„ä½¿ç”¨åˆ†ä¸ºâ€œå®šä¹‰â€å’Œâ€œè§¦å‘â€ä¸¤æ­¥ï¼Œè¯­æ³•ç®€æ´ä¸”ä¸¥æ ¼éµå¾ª Solidity ä½œç”¨åŸŸè§„åˆ™ã€‚

### 1. å®šä¹‰è‡ªå®šä¹‰é”™è¯¯
**å¿…é¡»åœ¨åˆçº¦å†…éƒ¨ã€å‡½æ•°å¤–éƒ¨**ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰å®šä¹‰ï¼Œæ”¯æŒæ·»åŠ å‚æ•°ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
```solidity
// è¯­æ³•ï¼šerror é”™è¯¯å(å‚æ•°ç±»å‹ å‚æ•°å, ...);
error NotOwner(address caller, address expectedOwner); // å¸¦å‚æ•°
error InsufficientBalance(); // æ— å‚æ•°
error InvalidInput(uint256 input, uint256 minAllowed); // å¤šå‚æ•°
```
- **å‘½åè§„èŒƒ**ï¼šæ¨èä½¿ç”¨ `PascalCase`ï¼ˆé¦–å­—æ¯å¤§å†™ï¼‰ï¼Œå¦‚ `TransferFailed` è€Œé `transferFailed`ï¼Œå¢å¼ºå¯è¯»æ€§ã€‚
- **å‚æ•°ä½œç”¨**ï¼šä¼ é€’é”™è¯¯å‘ç”Ÿæ—¶çš„å…³é”®æ•°æ®ï¼ˆå¦‚è°ƒç”¨è€…åœ°å€ã€å®é™…å€¼/æœŸæœ›å€¼ï¼‰ï¼Œä¾¿äºè°ƒè¯•ã€‚

### 2. è§¦å‘è‡ªå®šä¹‰é”™è¯¯
å¿…é¡»ä½¿ç”¨ `revert` å…³é”®å­—è§¦å‘ï¼Œ**ä¸èƒ½ç”¨ `require`**ï¼š
```solidity
// è¯­æ³•ï¼šif (é”™è¯¯æ¡ä»¶) revert é”™è¯¯å(å‚æ•°å€¼);
function withdraw() external {
    // 1. æ— å‚æ•°é”™è¯¯
    if (address(this).balance == 0) revert InsufficientBalance();

    // 2. å¸¦å‚æ•°é”™è¯¯
    if (msg.sender != owner) revert NotOwner(msg.sender, owner);

    // 3. å¤šå‚æ•°é”™è¯¯
    uint256 amount = 100;
    if (amount < 1000) revert InvalidInput(amount, 1000);
}
```


## äºŒã€å®Œæ•´ç¤ºä¾‹ï¼šè‡ªå®šä¹‰é”™è¯¯å®æˆ˜åˆçº¦
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20; // éœ€ â‰¥0.8.4

contract WalletWithCustomErrors {
    address public immutable owner;
    uint256 public minimumDeposit;

    // 1. é›†ä¸­å®šä¹‰æ‰€æœ‰é”™è¯¯ï¼ˆä¾¿äºç»´æŠ¤ï¼‰
    error NotOwner(address caller, address owner);
    error InsufficientDeposit(uint256 sent, uint256 required);
    error TransferFailed(address recipient, uint256 amount);
    error WithdrawDisabled();

    constructor(uint256 _minimumDeposit) {
        owner = msg.sender;
        minimumDeposit = _minimumDeposit;
    }

    // å­˜æ¬¾ï¼šè§¦å‘é‡‘é¢ä¸è¶³é”™è¯¯
    function deposit() external payable {
        if (msg.value < minimumDeposit) {
            // ä¼ é€’å®é™…é‡‘é¢å’Œè¦æ±‚é‡‘é¢
            revert InsufficientDeposit(msg.value, minimumDeposit);
        }
    }

    // ææ¬¾ï¼šè§¦å‘æƒé™/è½¬è´¦å¤±è´¥é”™è¯¯
    function withdraw(address recipient) external {
        // æƒé™æ ¡éªŒ
        if (msg.sender != owner) {
            revert NotOwner(msg.sender, owner);
        }

        // ææ¬¾å¼€å…³ï¼ˆç¤ºä¾‹ï¼‰
        if (block.timestamp < 1719744000) { // 2024-07-01 00:00:00
            revert WithdrawDisabled();
        }

        // è½¬è´¦é€»è¾‘
        uint256 balance = address(this).balance;
        (bool success, ) = recipient.call{value: balance}("");
        if (!success) {
            revert TransferFailed(recipient, balance);
        }
    }
}
```

### é”™è¯¯è§¦å‘åçš„è¿”å›ç»“æœ
å‰ç«¯è°ƒç”¨æ—¶ï¼Œé”™è¯¯ä¿¡æ¯ä¼šåŒ…å«å®Œæ•´å‚æ•°ï¼Œä¾¿äºå®šä½é—®é¢˜ï¼š
```json
{
  "error": "InsufficientDeposit",
  "args": {
    "sent": 500000000000000000, // 0.5 ETH
    "required": 1000000000000000000 // 1 ETH
  }
}
```


## ä¸‰ã€æ ¸å¿ƒå¯¹æ¯”ï¼šè‡ªå®šä¹‰é”™è¯¯ vs ä¼ ç»Ÿ `require`
è‡ªå®šä¹‰é”™è¯¯çš„ä¼˜åŠ¿åœ¨ä¸ `require` çš„å¯¹æ¯”ä¸­å°¤ä¸ºæ˜æ˜¾ï¼Œå°¤å…¶æ˜¯åœ¨ Gas æˆæœ¬å’Œè°ƒè¯•èƒ½åŠ›ä¸Šï¼š

| å¯¹æ¯”ç»´åº¦         | ä¼ ç»Ÿ `require` è¯­å¥                          | è‡ªå®šä¹‰é”™è¯¯ï¼ˆCustom Errorsï¼‰                   |
|------------------|---------------------------------------------|-----------------------------------------------|
| **è¯­æ³•é€»è¾‘**     | æ¡ä»¶åˆ¤æ–­ä¸æç¤ºè€¦åˆï¼š`require(cond, "msg")`  | é€»è¾‘ä¸é”™è¯¯åˆ†ç¦»ï¼š`if (!cond) revert Err(params)` |
| **Gas æ¶ˆè€—**     | é«˜ï¼ˆå­—ç¬¦ä¸²æ°¸ä¹…åµŒå…¥å­—èŠ‚ç ï¼‰                  | æä½ï¼ˆä»…4å­—èŠ‚é”™è¯¯é€‰æ‹©å™¨+åŠ¨æ€å‚æ•°ï¼‰            |
| **éƒ¨ç½²æˆæœ¬**     | é«˜ï¼ˆé•¿å­—ç¬¦ä¸²å¢åŠ åˆçº¦ä½“ç§¯ï¼‰                  | ä½ï¼ˆé”™è¯¯å®šä¹‰ä¸å ç”¨é¢å¤–å­˜å‚¨ï¼‰                  |
| **å‚æ•°ä¼ é€’**     | âŒ ä¸æ”¯æŒï¼ˆæç¤ºå›ºå®šï¼‰                       | âœ… æ”¯æŒåŠ¨æ€å‚æ•°ï¼ˆåœ°å€ã€æ•°å€¼ç­‰ä¸Šä¸‹æ–‡ï¼‰          |
| **è°ƒè¯•æ•ˆç‡**     | æ¨¡ç³Šæ–‡æœ¬ï¼ˆå¦‚â€œæƒé™ä¸è¶³â€ï¼‰                    | ç²¾å‡†ä¿¡æ¯ï¼ˆå¦‚â€œè°ƒç”¨è€…0x...ä¸æ˜¯æ‰€æœ‰è€…0x...â€ï¼‰    |
| **å¯ç»´æŠ¤æ€§**     | é”™è¯¯æç¤ºåˆ†æ•£åœ¨å‡½æ•°ä¸­                        | é›†ä¸­å®šä¹‰ï¼Œä¾¿äºå›¢é˜Ÿåä½œå’Œè¿­ä»£                  |
| **é€‚ç”¨åœºæ™¯**     | æç®€åŸå‹ã€ä¸´æ—¶éªŒè¯                          | ç”Ÿäº§çº§åˆçº¦ã€DeFiã€NFTç­‰å¤æ‚ç³»ç»Ÿ               |

### ğŸ” å®æµ‹ Gas å¯¹æ¯”ï¼ˆä»¥â€œæƒé™æ ¡éªŒâ€ä¸ºä¾‹ï¼‰
| å®ç°æ–¹å¼                | éƒ¨ç½² Gas æ¶ˆè€— | è°ƒç”¨å¤±è´¥æ—¶ Gas æ¶ˆè€— |
|-------------------------|---------------|---------------------|
| `require(msg.sender == owner, "Not owner")` | çº¦ 98,000    | çº¦ 23,000           |
| `if (!cond) revert NotOwner(msg.sender, owner)` | çº¦ 95,500 | çº¦ 21,500           |
> **ç»“è®º**ï¼šè‡ªå®šä¹‰é”™è¯¯å¯èŠ‚çœ **2%-5% çš„éƒ¨ç½² Gas** å’Œ **5%-10% çš„è°ƒç”¨å¤±è´¥ Gas**ï¼Œå¤æ‚åˆçº¦ä¸­å·®è·æ›´æ˜æ˜¾ã€‚


## å››ã€æ ¸å¿ƒä¼˜åŠ¿è§£æ
### 1. Gas ä¼˜åŒ–ï¼šä»â€œå­˜å‚¨å­—ç¬¦ä¸²â€åˆ°â€œé”™è¯¯é€‰æ‹©å™¨â€
ä¼ ç»Ÿ `require` çš„æœ€å¤§ç—›ç‚¹æ˜¯ **é”™è¯¯å­—ç¬¦ä¸²æ°¸ä¹…å­˜å‚¨åœ¨å­—èŠ‚ç ä¸­**ï¼Œè€Œè‡ªå®šä¹‰é”™è¯¯ä»…ä½¿ç”¨ä¸€ä¸ª **4å­—èŠ‚çš„é”™è¯¯é€‰æ‹©å™¨ï¼ˆError Selectorï¼‰**ï¼š
- é”™è¯¯é€‰æ‹©å™¨ï¼šé€šè¿‡ `keccak256("ErrorName(paramType1,paramType2)")` è®¡ç®—ï¼Œå¦‚ `NotOwner(address,address)` çš„é€‰æ‹©å™¨ä¸ºå›ºå®š4å­—èŠ‚å€¼ã€‚
- å‚æ•°åŠ¨æ€ä¼ é€’ï¼šä»…åœ¨é”™è¯¯è§¦å‘æ—¶ä¼ é€’å‚æ•°ï¼Œä¸å ç”¨åˆçº¦å­˜å‚¨ï¼Œå¤§å¹…é™ä½æˆæœ¬ã€‚

### 2. è°ƒè¯•å‡çº§ï¼šä»â€œæ¨¡ç³Šæç¤ºâ€åˆ°â€œä¸Šä¸‹æ–‡å®Œæ•´â€
ä¾‹å¦‚å¤„ç†è½¬è´¦å¤±è´¥æ—¶ï¼š
- `require(success, "Transfer failed");` â†’ ä»…çŸ¥é“å¤±è´¥ï¼Œæ— æ³•å®šä½æ˜¯å“ªä¸ªåœ°å€ã€å¤šå°‘é‡‘é¢å‡ºé—®é¢˜ï¼›
- `revert TransferFailed(recipient, balance);` â†’ ç›´æ¥è¿”å›å¤±è´¥åœ°å€å’Œé‡‘é¢ï¼Œå‰ç«¯å¯å¿«é€Ÿå®šä½é—®é¢˜ã€‚

### 3. ä»£ç é‡æ„ï¼šé”™è¯¯å®šä¹‰é›†ä¸­åŒ–
å¤§å‹åˆçº¦ä¸­ï¼Œè‡ªå®šä¹‰é”™è¯¯å°†åˆ†æ•£çš„é”™è¯¯æç¤ºé›†ä¸­ç®¡ç†ï¼Œä¾¿äºï¼š
- ç»Ÿä¸€é”™è¯¯è§„èŒƒï¼ˆå¦‚å‘½åã€å‚æ•°æ ¼å¼ï¼‰ï¼›
- å¿«é€Ÿä¿®æ”¹é”™è¯¯é€»è¾‘ï¼ˆæ— éœ€éå†æ‰€æœ‰å‡½æ•°ï¼‰ï¼›
- æ–°å¼€å‘è€…å¿«é€Ÿç†è§£åˆçº¦çš„é”™è¯¯åœºæ™¯ã€‚


## äº”ã€ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ
### 1. ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯çš„åœºæ™¯
| åœºæ™¯ç±»å‹               | åŸå› åˆ†æ                                  | ç¤ºä¾‹                                  |
|------------------------|-------------------------------------------|---------------------------------------|
| **DeFi åˆçº¦**ï¼ˆå¦‚å€Ÿè´·ã€DEXï¼‰ | Gas æˆæœ¬æ•æ„Ÿï¼Œé”™è¯¯è°ƒè¯•éœ€ç²¾å‡†ä¸Šä¸‹æ–‡        | `InsufficientCollateral(user, required)` |
| **æƒé™ç®¡ç†**ï¼ˆå¦‚ ownerã€roleï¼‰ | éœ€æ˜ç¡®â€œè°æ— æƒé™â€â€œåº”æœ‰ä»€ä¹ˆæƒé™â€            | `Unauthorized(caller, requiredRole)`  |
| **å‚æ•°æ ¡éªŒ**ï¼ˆå¦‚è¾“å…¥å€¼èŒƒå›´ï¼‰ | éœ€è¿”å›â€œå®é™…è¾“å…¥â€ä¸â€œåˆæ³•èŒƒå›´â€å¯¹æ¯”          | `InvalidAmount(input, min, max)`      |
| **è·¨åˆçº¦è°ƒç”¨**          | éœ€ä¼ é€’è·¨åˆçº¦é”™è¯¯ä¸Šä¸‹æ–‡ï¼ˆå¦‚è°ƒç”¨å¤–éƒ¨åˆçº¦å¤±è´¥ï¼‰| `ExternalCallFailed(target, data)`    |

### 2. å¯ä½¿ç”¨ `require` çš„æç®€åœºæ™¯
è‹¥é”™è¯¯é€»è¾‘æç®€å•ä¸”æ— å‚æ•°éœ€æ±‚ï¼Œ`require` æ›´ç®€æ´ï¼š
```solidity
// âœ… å¯æ¥å—ï¼šæç®€æƒé™æ ¡éªŒï¼Œæ— é¢å¤–ä¸Šä¸‹æ–‡éœ€æ±‚
function pause() external {
    require(msg.sender == owner, "Owner only");
}
```

### 3. è¿›é˜¶å®è·µï¼šè·¨åˆçº¦å¤ç”¨é”™è¯¯
é€šè¿‡æ¥å£å®šä¹‰é”™è¯¯ï¼Œå®ç°å¤šåˆçº¦å…±äº«é”™è¯¯è§„èŒƒï¼š
```solidity
// 1. å®šä¹‰é”™è¯¯æ¥å£
interface ICommonErrors {
    error NotOwner(address caller);
    error InvalidInput();
    error ActionDisabled();
}

// 2. åˆçº¦ç»§æ‰¿æ¥å£å¤ç”¨é”™è¯¯
contract MyContract is ICommonErrors {
    function foo() external {
        if (msg.sender != owner) revert NotOwner(msg.sender); // ç›´æ¥ä½¿ç”¨æ¥å£å®šä¹‰çš„é”™è¯¯
    }
}
```


## å…­ã€å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘æŒ‡å—ï¼‰
1. **â— å®šä¹‰ä½ç½®é™åˆ¶**  
   è‡ªå®šä¹‰é”™è¯¯**ä¸èƒ½åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰**ï¼Œå¿…é¡»åœ¨åˆçº¦/æ¥å£çš„å…¨å±€ä½œç”¨åŸŸï¼š
   ```solidity
   function badExample() external {
       error InFunctionError(); // âŒ ç¼–è¯‘é”™è¯¯ï¼šå‡½æ•°å†…ä¸èƒ½å®šä¹‰é”™è¯¯
       revert InFunctionError();
   }
   ```

2. **â— è§¦å‘æ–¹å¼é™åˆ¶**  
   åªèƒ½ç”¨ `revert` è§¦å‘ï¼Œ**ä¸èƒ½ç”¨ `require` æˆ– `assert`**ï¼š
   ```solidity
   // âŒ é”™è¯¯è¯­æ³•ï¼šrequire ä¸èƒ½è°ƒç”¨è‡ªå®šä¹‰é”™è¯¯
   require(msg.sender == owner, NotOwner(msg.sender));

   // âœ… æ­£ç¡®ï¼šç”¨ revert è§¦å‘
   if (msg.sender != owner) revert NotOwner(msg.sender);
   ```

3. **â— ç‰ˆæœ¬å…¼å®¹æ€§**  
   å¿…é¡»ä½¿ç”¨ **Solidity 0.8.4 åŠä»¥ä¸Šç‰ˆæœ¬**ï¼Œå¦åˆ™ç¼–è¯‘å™¨ä¸è¯†åˆ« `error` å…³é”®å­—ï¼š
   ```solidity
   // âŒ é”™è¯¯ï¼š0.8.3 åŠä»¥ä¸‹ç‰ˆæœ¬ä¸æ”¯æŒ
   pragma solidity ^0.8.3;
   error MyError();
   ```

4. **â— å‚æ•°ç±»å‹é™åˆ¶**  
   é”™è¯¯å‚æ•°ä»…æ”¯æŒ **å€¼ç±»å‹**ï¼ˆå¦‚ `address`ã€`uint256`ã€`bool`ï¼‰ï¼Œä¸æ”¯æŒå¼•ç”¨ç±»å‹ï¼ˆå¦‚ `string`ã€`array`ï¼‰ï¼š
   ```solidity
   // âŒ é”™è¯¯ï¼šå‚æ•°ä¸èƒ½æ˜¯ string å¼•ç”¨ç±»å‹
   error InvalidString(string input);

   // âœ… æ­£ç¡®ï¼šç”¨ bytes32 æ›¿ä»£ string
   error InvalidString(bytes32 input);
   ```


## ä¸ƒã€è¿›é˜¶æŠ€å·§ï¼šé”™è¯¯ä¸äº‹ä»¶çš„ååŒè°ƒè¯•
è‡ªå®šä¹‰é”™è¯¯è´Ÿè´£â€œè§¦å‘å¼‚å¸¸â€ï¼Œäº‹ä»¶ï¼ˆEventï¼‰è´Ÿè´£â€œè®°å½•è¿‡ç¨‹â€ï¼Œä¸¤è€…ç»“åˆå¯æä¾›å®Œæ•´çš„è°ƒè¯•é“¾è·¯ï¼š
```solidity
contract WalletWithEventsAndErrors {
    event DepositAttempt(address indexed user, uint256 amount);
    event WithdrawAttempt(address indexed user, address indexed recipient);

    error InsufficientDeposit(uint256 sent, uint256 required);

    function deposit() external payable {
        emit DepositAttempt(msg.sender, msg.value); // è®°å½•å°è¯•
        if (msg.value < 1 ether) revert InsufficientDeposit(msg.value, 1 ether); // è§¦å‘é”™è¯¯
    }

    function withdraw(address recipient) external {
        emit WithdrawAttempt(msg.sender, recipient); // è®°å½•å°è¯•
        if (msg.sender != owner) revert NotOwner(msg.sender, owner);
        // ... è½¬è´¦é€»è¾‘
    }
}
```
- **ä¼˜åŠ¿**ï¼šå³ä½¿é”™è¯¯è§¦å‘ï¼Œäº‹ä»¶ä»ä¼šè¢«è®°å½•ï¼Œå¯é€šè¿‡åŒºå—é“¾æµè§ˆå™¨ï¼ˆå¦‚ Etherscanï¼‰æŸ¥çœ‹â€œé”™è¯¯å‘ç”Ÿå‰çš„æ“ä½œâ€ï¼Œè¿˜åŸå®Œæ•´åœºæ™¯ã€‚


## å…«ã€æ€»ç»“ï¼šè‡ªå®šä¹‰é”™è¯¯çš„æ ¸å¿ƒä»·å€¼
| ä»·å€¼ç»´åº¦         | å…·ä½“ä½“ç°                                  |
|------------------|-------------------------------------------|
| **æˆæœ¬ä¼˜åŒ–**     | é™ä½åˆçº¦éƒ¨ç½²å’Œè°ƒç”¨çš„ Gas æ¶ˆè€—ï¼Œå°¤å…¶é€‚åˆé«˜é¢‘äº¤äº’åœºæ™¯ |
| **è°ƒè¯•æ•ˆç‡**     | æä¾›ç²¾å‡†ä¸Šä¸‹æ–‡å‚æ•°ï¼Œå‡å°‘é—®é¢˜å®šä½æ—¶é—´        |
| **ä»£ç è´¨é‡**     | é”™è¯¯å®šä¹‰é›†ä¸­åŒ–ï¼Œæå‡å¯ç»´æŠ¤æ€§å’Œå›¢é˜Ÿåä½œæ•ˆç‡  |
| **ç”Ÿæ€é€‚é…**     | ä¸»æµå·¥å…·ï¼ˆRemixã€Hardhatã€Truffleï¼‰å‡å·²å®Œç¾æ”¯æŒ |

> ğŸ **æœ€ç»ˆå»ºè®®**ï¼š  
> åœ¨ **Solidity 0.8.4+** ç¯å¢ƒä¸‹ï¼Œ**è‡ªå®šä¹‰é”™è¯¯åº”ä½œä¸ºé¦–é€‰é”™è¯¯å¤„ç†æ–¹å¼**ï¼Œä»…åœ¨æç®€æ— å‚æ•°åœºæ™¯ä¸‹è€ƒè™‘ `require`ã€‚å¯¹äºç”Ÿäº§çº§åˆçº¦ï¼ˆå°¤å…¶æ˜¯ DeFiã€NFT ç­‰ç”¨æˆ·é‡é«˜çš„é¡¹ç›®ï¼‰ï¼Œè‡ªå®šä¹‰é”™è¯¯æ˜¯æå‡åˆçº¦è´¨é‡çš„â€œæ ‡é…â€ã€‚
